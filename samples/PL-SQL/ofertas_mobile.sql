/**
 * @author Isabel Palomar
 * Fecha 29 noviembre 2012 



 * Obtain personalized offers of a specific customer  -sample---------------------------------------------------------------------------------
 */

select r.* from (
  select o.*, rownum o_rownum
  from (
    select oferta.*
    from TBL_OFERTAS oferta
    join DIC_TIPOS_OFERTA tipo on tipo.ID_TIPO_OFERTA = oferta.ID_TIPO_OFERTA
    where 1=1
      and tipo.TIPO_OFERTA = 'PERSONALIZADA'
      and oferta.VALIDADA = 'S'
      and oferta.ID_OFERTA in (
        select ID_OFERTA from REL_OFERTAS_CLIENTE where ID_CLIENTE = '4'
      )
  ) o   where rownum <= '31'
) r where o_rownum > 1


/**
 * Obtain personalized suggested offers of a specific customer  -sample  -----------------------------------------------------------------
 */

select r.* from (
  select o.*, rownum o_rownum
  from (
    select oferta.*
    from TBL_OFERTAS oferta
    join DIC_TIPOS_OFERTA tipo on tipo.ID_TIPO_OFERTA = oferta.ID_TIPO_OFERTA
    where 1=1
      and tipo.TIPO_OFERTA = 'SUGERIDA'
      and oferta.VALIDADA = 'S'
      and oferta.ID_OFERTA in (
        select ID_OFERTA from REL_OFERTAS_CLIENTE where ID_CLIENTE = '4'
      )
    
  ) o   where rownum <= '31'
) r where o_rownum > 0

/**
/*   Obtain personalized and suggested offers --- new sample ---------------------------------------------------------------------------------
*/

SELECT REGISTROS.*
FROM (
    SELECT OFERTAS.*, ROWNUM O_ROWNUM 
    FROM (
        SELECT 
            O.ID_OFERTA,
            O.TITULO,
            (SELECT C.CATEGORIA FROM DIC_CATEGORIAS C, DIC_SUBCATEGORIAS S, REL_SUBCATEGORIAS_OFERTA SO WHERE S.ID_SUBCATEGORIA = SO.ID_SUBCATEGORIA AND C.ID_CATEGORIA = S.ID_CATEGORIA AND SO.ID_OFERTA = O.ID_OFERTA AND ROWNUM = 1) AS CATEGORIA,
            (SELECT S.SUBCATEGORIA FROM DIC_SUBCATEGORIAS S, REL_SUBCATEGORIAS_OFERTA SO WHERE S.ID_SUBCATEGORIA = SO.ID_SUBCATEGORIA AND SO.ID_OFERTA = O.ID_OFERTA AND ROWNUM = 1) AS SUBCATEGORIA,
            (SELECT ARCHIVO_IMAGEN FROM DIC_IMAGENES WHERE ID_IMAGEN = O.ID_IMAGEN) AS IMAGEN,
            O.PRECIO_REAL,
            O.BENEFICIO,
            TRUNC(O.FECHA_FIN)-TRUNC(TO_DATE((SELECT SYSDATE FROM DUAL))) AS DIAS_VIGENCIA,
            (select Decode (COUNT(1), 0, 'N', 'S')  from LOG_ACEPTACIONES_OFERTA where ID_CLIENTE = '2043' AND ID_OFERTA = O.ID_OFERTA)  AS TOMADA,
            --TO_DATE((SELECT SYSDATE FROM DUAL)),
            (select COUNT(1) from REL_OFERTAS_CLIENTE where ID_CLIENTE = '2043' AND ID_OFERTA = O.ID_OFERTA)  AS OFERTA_PERSONALIZADA
        FROM TBL_OFERTAS O
        WHERE O.ID_TIPO_OFERTA = 3
        AND   O.VALIDADA = 'S'
        AND   O.ACTIVO = 'S'
    ) OFERTAS
    WHERE OFERTA_PERSONALIZADA > 0
    AND DIAS_VIGENCIA >=0
    AND ROWNUM <= 10 -- PI_NUM_REG_FIN
    ) REGISTROS
WHERE O_ROWNUM > 0 -- PI_NUM_REG_INI

/*
/* Obtain suggested and personalized offers of a specific customer -------------------------------------------------------------------------
*/

SELECT  COUNT(*)  as total
  FROM (     
        SELECT OFERTAS.*, ROWNUM O_ROWNUM     
          FROM (     
                SELECT     
                  O.ID_OFERTA,     
    		  O.TITULO,     
		  (SELECT C.CATEGORIA FROM DIC_CATEGORIAS C, DIC_SUBCATEGORIAS S, REL_SUBCATEGORIAS_OFERTA SO WHERE S.ID_SUBCATEGORIA = SO.ID_SUBCATEGORIA AND C.ID_CATEGORIA = S.ID_CATEGORIA AND SO.ID_OFERTA = O.ID_OFERTA AND ROWNUM = 1) AS CATEGORIA,     
    		  (SELECT S.SUBCATEGORIA FROM DIC_SUBCATEGORIAS S, REL_SUBCATEGORIAS_OFERTA SO WHERE S.ID_SUBCATEGORIA = SO.ID_SUBCATEGORIA AND SO.ID_OFERTA = O.ID_OFERTA AND ROWNUM = 1) AS SUBCATEGORIA,     
    		  (SELECT ARCHIVO_IMAGEN FROM DIC_IMAGENES WHERE ID_IMAGEN = O.ID_IMAGEN) AS IMAGEN,     
    		  O.PRECIO_REAL,     
    		  O.BENEFICIO,     
    		  TRUNC(O.FECHA_FIN)-TRUNC(TO_DATE((SELECT SYSDATE FROM DUAL))) AS DIAS_VIGENCIA,     
                  (select Decode (COUNT(1), 0, 'N', 'S')  from LOG_ACEPTACIONES_OFERTA where ID_CLIENTE = '2043' AND ID_OFERTA = O.ID_OFERTA)  AS TOMADA,     
                  (select COUNT(1) from REL_OFERTAS_CLIENTE where ID_CLIENTE = '2043' AND ID_OFERTA = O.ID_OFERTA)  AS OFERTA_PERSONALIZADA     
                FROM TBL_OFERTAS O     
                WHERE O.ID_TIPO_OFERTA =  '3'     
                AND   O.VALIDADA = 'S'     
                AND   O.ACTIVO = 'S'     
            ) OFERTAS     
    	 WHERE OFERTA_PERSONALIZADA > 0     
			 AND DIAS_VIGENCIA >=0     
 ) REGISTROS;




/**
* Obtain taken offers of a specific customer --- sample -----------------------------------------------------------------------------------------
*/

  SELECT REGISTROS.*
	FROM (
	    SELECT OFERTAS.*, ROWNUM O_ROWNUM 
	    FROM (
		SELECT 
		    O.ID_OFERTA,
		    O.TITULO,
		    (SELECT C.CATEGORIA FROM DIC_CATEGORIAS C, DIC_SUBCATEGORIAS S, REL_SUBCATEGORIAS_OFERTA SO WHERE S.ID_SUBCATEGORIA = SO.ID_SUBCATEGORIA AND C.ID_CATEGORIA = S.ID_CATEGORIA AND SO.ID_OFERTA = O.ID_OFERTA AND ROWNUM = 1) AS CATEGORIA,
		    (SELECT S.SUBCATEGORIA FROM DIC_SUBCATEGORIAS S, REL_SUBCATEGORIAS_OFERTA SO WHERE S.ID_SUBCATEGORIA = SO.ID_SUBCATEGORIA AND SO.ID_OFERTA = O.ID_OFERTA AND ROWNUM = 1) AS SUBCATEGORIA,
		    (SELECT ARCHIVO_IMAGEN FROM DIC_IMAGENES WHERE ID_IMAGEN = O.ID_IMAGEN) AS IMAGEN,
		    O.PRECIO_REAL,
		    O.BENEFICIO,
		    (SELECT  PA_GENERAL.F_FORMATO_FECHA(FECHA_ACEPTACION, 2) FROM LOG_ACEPTACIONES_OFERTA WHERE ID_OFERTA = O.ID_OFERTA AND ID_CLIENTE = 2043 AND ROWNUM = 1) AS FECHA_ACEPTACION_FORMATO, -- PI_ID_CLIENTE
		    (SELECT FECHA_ACEPTACION FROM LOG_ACEPTACIONES_OFERTA WHERE ID_OFERTA = O.ID_OFERTA AND ID_CLIENTE = 2043 AND ROWNUM = 1) AS FECHA_ACEPTACION, -- PI_ID_CLIENTE
		    (SELECT COUNT(1) FROM LOG_ACEPTACIONES_OFERTA WHERE ID_OFERTA = O.ID_OFERTA AND ID_CLIENTE = 2043) AS ACEPTADAS -- PI_ID_CLIENTE
		FROM TBL_OFERTAS O
	    ) OFERTAS
	    WHERE ACEPTADAS > 0
	    AND ROWNUM <= 6 -- PI_NUM_REG_FIN
	    ) REGISTROS
	WHERE O_ROWNUM > 5 -- PI_NUM_REG_INI
	ORDER BY FECHA_ACEPTACION DESC;

/**
/* Obtain total number of taken offers ---------------------------------------------------------------------------------------------------------
*/


SELECT COUNT(*) AS TOTAL    
        FROM (       
        SELECT OFERTAS.*, ROWNUM O_ROWNUM    
        FROM (    
        SELECT    
          O.ID_OFERTA,    
          O.TITULO,       
          (SELECT C.CATEGORIA FROM DIC_CATEGORIAS C, DIC_SUBCATEGORIAS S, REL_SUBCATEGORIAS_OFERTA SO WHERE S.ID_SUBCATEGORIA = SO.ID_SUBCATEGORIA AND C.ID_CATEGORIA = S.ID_CATEGORIA AND SO.ID_OFERTA = O.ID_OFERTA AND ROWNUM = 1) AS CATEGORIA,    
        	(SELECT S.SUBCATEGORIA FROM DIC_SUBCATEGORIAS S, REL_SUBCATEGORIAS_OFERTA SO WHERE S.ID_SUBCATEGORIA = SO.ID_SUBCATEGORIA AND SO.ID_OFERTA = O.ID_OFERTA AND ROWNUM = 1) AS SUBCATEGORIA,    
          (SELECT ARCHIVO_IMAGEN FROM DIC_IMAGENES WHERE ID_IMAGEN = O.ID_IMAGEN) AS IMAGEN,    
        	O.PRECIO_REAL,    
        	O.BENEFICIO,      
        	(SELECT  PA_GENERAL.F_FORMATO_FECHA(FECHA_ACEPTACION, 2)  FROM LOG_ACEPTACIONES_OFERTA WHERE ID_OFERTA = O.ID_OFERTA AND ID_CLIENTE = '2043' AND ROWNUM = 1) AS FECHA_ACEPTACION_FORMATO, -- PI_ID_CLIENTE    
        	(SELECT  FECHA_ACEPTACION  FROM LOG_ACEPTACIONES_OFERTA WHERE ID_OFERTA = O.ID_OFERTA AND ID_CLIENTE = '2043' AND ROWNUM = 1) AS FECHA_ACEPTACION, -- PI_ID_CLIENTE    
        	(SELECT COUNT(1) FROM LOG_ACEPTACIONES_OFERTA WHERE ID_OFERTA = O.ID_OFERTA AND ID_CLIENTE = '2043') AS ACEPTADAS -- PI_ID_CLIENTE    
        	FROM TBL_OFERTAS O    
					) OFERTAS     
        WHERE ACEPTADAS > 0       
    ) REGISTROS    
ORDER BY FECHA_ACEPTACION DESC;




/**
/* Obtain offer detail  -- new sample---------------------------------------------------------------------------------------------------------
*/


SELECT 
    O.TITULO,
    (SELECT C.CATEGORIA FROM DIC_CATEGORIAS C, DIC_SUBCATEGORIAS S, REL_SUBCATEGORIAS_OFERTA SO WHERE S.ID_SUBCATEGORIA = SO.ID_SUBCATEGORIA AND C.ID_CATEGORIA = S.ID_CATEGORIA AND SO.ID_OFERTA = O.ID_OFERTA AND ROWNUM = 1) AS CATEGORIA,
    (SELECT S.SUBCATEGORIA FROM DIC_SUBCATEGORIAS S, REL_SUBCATEGORIAS_OFERTA SO WHERE S.ID_SUBCATEGORIA = SO.ID_SUBCATEGORIA AND SO.ID_OFERTA = O.ID_OFERTA AND ROWNUM = 1) AS SUBCATEGORIA,
    (SELECT ARCHIVO_IMAGEN FROM DIC_IMAGENES WHERE ID_IMAGEN = O.ID_IMAGEN) AS IMAGEN,
    O.PRECIO_REAL,
    O.BENEFICIO,
    o.DESCRIPCION,
    TRUNC(O.FECHA_FIN)-TRUNC(O.FECHA_INICIO) AS DIAS_VIGENCIA,
    O.CONDICIONES,
    O.DETALLES,
    (SELECT AGRADO FROM REL_OFERTAS_CLIENTE WHERE ID_OFERTA = O.ID_OFERTA AND ID_CLIENTE = 2043 AND ROWNUM = 1) AS AGRADO,
    (select Decode (COUNT(1), 0, 'N', 'S')  from LOG_ACEPTACIONES_OFERTA where ID_CLIENTE = '2043' AND ID_OFERTA = O.ID_OFERTA)  AS TOMADA,
    (SELECT PA_GENERAL.F_FORMATO_FECHA(FECHA_ACEPTACION, 2) FROM LOG_ACEPTACIONES_OFERTA WHERE ID_OFERTA = O.ID_OFERTA AND ID_CLIENTE = 2043 AND ROWNUM = 1) AS FECHA_ACEPTACION
FROM TBL_OFERTAS O
WHERE O.ID_OFERTA = 69 -- PI_ID_OFERTA







